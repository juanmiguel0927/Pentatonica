<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Pentatónicas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 1rem 2rem;
        }
        .tabs button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            color: #9ca3af;
            background-color: #1f2937;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .tabs button.active {
            background-color: #3b82f6;
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .tabs button:hover:not(.active) {
            background-color: #374151;
            color: #e5e7eb;
        }
        .tab-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-top: 1.5rem;
        }
        h1, h2, h3 { color: #fff; }
        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .input-group label {
            font-weight: 500;
            color: #fff;
        }
        .input-group select {
            background-color: #374151;
            border-radius: 8px;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            color: #fff;
        }
        .action-button {
            background-color: #3b82f6;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            background-color: #2563eb;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }
        .action-button.stop-btn { background-color: #ef4444; }
        .action-button.stop-btn:hover { background-color: #dc2626; }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #374151;
            vertical-align: top;
        }
        th {
            background-color: #374151;
            font-weight: 600;
        }
        tr.selected-row {
            background-color: #3b82f6;
        }
        tr.selected-row, tr.selected-row .text-gray-400 {
            color: #ffffff;
        }
        tr:last-child td { border-bottom: none; }
        .example-box {
            background-color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            font-family: monospace;
            font-size: 0.85rem;
            color: #fff;
            white-space: pre; 
        }

        /* Progression Tab Styles */
        .progression-card {
            background-color: #374151;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            height: 100%;
        }
        .chord-box {
            background-color: #4b5563;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .progression-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .prog-type-selector button { background-color: #374151; }
        .prog-type-selector button.active { background-color: #3b82f6; }
        .scale-suggestions li.selected-scale {
            background-color: #3b82f6;
        }
        .scale-suggestions li.selected-scale, .scale-suggestions li.selected-scale span {
            color: #ffffff !important;
        }

        /* Fretboard Visualizer Styles */
        .visualizer-container {
            background-color: #111827;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
        }
        .fretboard-area {
            display: flex;
            align-items: center;
        }
        .open-strings {
            display: flex;
            flex-direction: column;
            margin-right: 15px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .open-string-name {
            height: 41px;
            display: flex;
            align-items: center;
            color: #6b7280; /* Dimmed color for strings not in scale */
            transition: color 0.3s ease;
        }
        .open-string-name.in-scale {
            color: #e5e7eb; /* Bright color for in-scale */
        }
        .open-string-name.root {
            color: #ef4444; /* Red for root note */
        }
        .fretboard-wrapper {
            position: relative;
            padding: 10px 0;
            display: inline-block;
        }
        .fretboard {
            background-color: #6b3e24;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            border: 2px solid #4a2c1a;
        }
        .string {
            display: flex;
            align-items: center;
        }
        .string:not(:last-child) {
            border-bottom: 1px solid #4a2c1a;
        }
        .fret {
            width: 60px;
            height: 40px;
            border-right: 2px solid #a0a0a0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .fret.nut {
            border-right: 8px solid #2d1a0e;
            width: 20px;
        }
        .note-dot {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            position: absolute;
            background-color: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.7);
            z-index: 10;
        }
        .note-dot.root {
            background-color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.7);
        }
        .inlay-container {
            position: absolute;
            top: 0;
            left: 20px; /* Past the nut */
            width: calc(100% - 20px);
            height: 100%;
            display: flex;
            pointer-events: none;
        }
        .inlay-fret {
            width: 60px; /* Match new fret width */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .inlay-dot {
            width: 10px;
            height: 10px;
            background-color: #d1c1a9;
            border-radius: 50%;
            position: absolute;
        }
        .inlay-dot.double {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 20px; /* Explicit height for spacing */
            background-color: transparent;
        }
        .inlay-dot.double::before, .inlay-dot.double::after {
            content: '';
            width: 10px;
            height: 10px;
            background-color: #d1c1a9;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container">
        <h1 class="text-4xl font-bold text-center my-8">Laboratorio de Pentatónicas</h1>
        <p class="text-center text-lg mb-4 text-gray-400">
            Conceptos de improvisación con pentatónicas.
        </p>
        <p class="text-center text-sm mb-8 text-gray-500">
            Por: Juan Miguel Rios Redondo
        </p>
        <div class="flex flex-wrap gap-4 justify-center tabs" id="tabs-container">
            <button class="tab-button active" data-tab="simple">Pentatónicas y Arpegios</button>
            <button class="tab-button" data-tab="progression">Progresiones ii-V-I</button>
        </div>

        <!-- Tab 1: Pentatonics & Arpeggios -->
        <div class="tab-content" id="tab-simple">
            <h2 class="text-2xl font-semibold mb-4 text-center">Explorador de Pentatónicas y Arpegios Derivados</h2>
            <div class="input-group">
                <label for="root-note">Tonalidad del Acorde:</label>
                <select id="root-note"></select>
                <label for="chord-type">Tipo de Acorde:</label>
                <select id="chord-type"></select>
            </div>
            <div id="simple-mode-content">
                <table class="bg-gray-800 rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Pentatónica a usar</th>
                            <th>Tríadas Derivadas</th>
                            <th>Tétradas Derivadas</th>
                            <th>Grados sobre el Acorde</th>
                            <th class="rounded-tr-lg">Lógica y Sonido</th>
                        </tr>
                    </thead>
                    <tbody id="scale-table-body">
                    </tbody>
                </table>
                <div class="visualizer-container" id="fretboard-container-simple">
                </div>
            </div>
        </div>
        
        <!-- Tab 2: Progressions -->
        <div class="tab-content hidden" id="tab-progression">
            <h2 class="text-2xl font-semibold mb-4 text-center">Generador de Progresiones ii-V-I</h2>
            
            <div class="input-group">
                <label for="progression-key">Tonalidad (del 'I'):</label>
                <select id="progression-key"></select>
                <div class="flex gap-2 p-1 bg-gray-700 rounded-full prog-type-selector">
                    <button class="action-button active" data-prog-type="major">Mayor</button>
                    <button class="action-button" data-prog-type="minor">Menor</button>
                </div>
            </div>

            <div class="input-group">
                <button id="play-progression-btn" class="action-button">Tocar Acordes</button>
                 <button id="play-solo-btn" class="action-button">Generar y Tocar Solo</button>
                <button id="stop-btn" class="action-button stop-btn">Parar</button>
            </div>
            
            <div id="progression-container"></div>

            <div class="visualizer-container" id="fretboard-container-progression">
            </div>
        </div>

    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DATA AND CONFIGURATIONS (with theoretical correctness) ---
        const FLAT_NOTES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        const SHARP_NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const KEY_SIGNATURES = {
            'C':  { type: 'sharp', scale: ['C', 'D', 'E', 'F', 'G', 'A', 'B'] }, 'G':  { type: 'sharp', scale: ['G', 'A', 'B', 'C', 'D', 'E', 'F#'] },
            'D':  { type: 'sharp', scale: ['D', 'E', 'F#', 'G', 'A', 'B', 'C#'] }, 'A':  { type: 'sharp', scale: ['A', 'B', 'C#', 'D', 'E', 'F#', 'G#'] },
            'E':  { type: 'sharp', scale: ['E', 'F#', 'G#', 'A', 'B', 'C#', 'D#'] }, 'B':  { type: 'sharp', scale: ['B', 'C#', 'D#', 'E', 'F#', 'G#', 'A#'] },
            'F#': { type: 'sharp', scale: ['F#', 'G#', 'A#', 'B', 'C#', 'D#', 'E#'] }, 'C#': { type: 'sharp', scale: ['C#', 'D#', 'E#', 'F#', 'G#', 'A#', 'B#'] },
            'F':  { type: 'flat',  scale: ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'] }, 'Bb': { type: 'flat',  scale: ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'] },
            'Eb': { type: 'flat',  scale: ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'] }, 'Ab': { type: 'flat',  scale: ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'] },
            'Db': { type: 'flat',  scale: ['Db', 'Eb', 'F', 'Gb', 'Ab', 'Bb', 'C'] }, 'Gb': { type: 'flat',  scale: ['Gb', 'Ab', 'Bb', 'Cb', 'Db', 'Eb', 'F'] },
            'Cb': { type: 'flat',  scale: ['Cb', 'Db', 'Eb', 'Fb', 'Gb', 'Ab', 'Bb'] }
        };

        const MINOR_PENTATONIC_SCALES = {
            'Bb': ['Bb', 'Db', 'Eb', 'F', 'Ab'], 'Eb': ['Eb', 'Gb', 'Ab', 'Bb', 'Db'],
            'Ab': ['Ab', 'Cb', 'Db', 'Eb', 'Gb'], 'Db': ['Db', 'Fb', 'Gb', 'Ab', 'Cb'],
            'Gb': ['Gb', 'Bbb', 'Cb', 'Db', 'Fb'], 'C':  ['C', 'Eb', 'F', 'G', 'Bb'],
            'C#': ['C#', 'E', 'F#', 'G#', 'B'],  'D':  ['D', 'F', 'G', 'A', 'C'],
            'E':  ['E', 'G', 'A', 'B', 'D'],   'F#': ['F#', 'A', 'B', 'C#', 'E'],
            'G':  ['G', 'Bb', 'C', 'D', 'F'],   'A':  ['A', 'C', 'D', 'E', 'G'],
            'B':  ['B', 'D', 'E', 'F#', 'A'],
            // Enharmonic equivalents for completeness
            'A#': ['A#', 'C#', 'D#', 'E#', 'G#'], 'D#': ['D#', 'F#', 'G#', 'A#', 'C#'],
            'G#': ['G#', 'B', 'C#', 'D#', 'F#'],
        };
        
        const noteNameToIndex = (name) => {
            const flatIndex = FLAT_NOTES.indexOf(name);
            return (flatIndex !== -1) ? flatIndex : SHARP_NOTES.indexOf(name);
        };
        
        const getPreferredNotes = (note, chordType) => {
            const keySig = KEY_SIGNATURES[note];
            if (keySig) return keySig.type === 'flat' ? FLAT_NOTES : SHARP_NOTES;
            if (chordType.includes('m') || chordType.includes('alt') || note.includes('b')) return FLAT_NOTES;
            return SHARP_NOTES;
        };

        const getNoteFromInterval = (rootNote, interval, preferredNotes) => {
            const rootIndex = noteNameToIndex(rootNote);
            const finalIndex = (rootIndex + interval) % 12;
            return preferredNotes[finalIndex];
        };
        
        const getIntervalName = (rootNote, targetNote, chordType) => {
            const rootIndex = noteNameToIndex(rootNote);
            const targetIndex = noteNameToIndex(targetNote);
            const interval = (targetIndex - rootIndex + 12) % 12;
            
            const rootLetter = rootNote.charAt(0);
            const targetLetter = targetNote.charAt(0);
            const diatonicScale = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const rootDiatonicIndex = diatonicScale.indexOf(rootLetter);
            const targetDiatonicIndex = diatonicScale.indexOf(targetLetter);
            
            let degree = (targetDiatonicIndex - rootDiatonicIndex + 7) % 7;

            // This logic is simplified for clarity and correctness in common cases.
            switch (interval) {
                case 0: return 'R';
                case 1: return 'b9';
                case 2: return '9';
                case 3: return chordType.includes('m') ? 'b3' : '#9';
                case 4: return '3';
                case 5: return '11';
                case 6: return chordType.includes('dom') || chordType.includes('alt') ? '#11' : 'b5';
                case 7: return '5';
                case 8: return chordType.includes('m') ? 'b6' : '#5'; // Simplified for common use
                case 9: return chordType.includes('m') ? '6' : 'b13'; // Simplified for common use
                case 10: return 'b7';
                case 11: return '7';
                default: return '?';
            }
        };
        
        const pentatonicFormulas = {
            'minor': [0, 3, 5, 7, 10], 'dom7': [0, 2, 4, 7, 10],
            'm7b5': [0, 3, 5, 6, 10], 'majb6': [0, 2, 4, 7, 8]
        };
        const chordFormulas = {
            'maj7': [0, 4, 7, 11], 'm7': [0, 3, 7, 10], 'dom7': [0, 4, 7, 10],
            'm7b5': [0, 3, 6, 10], 'alt': [0, 4, 10, 3, 6, 8]
        };
        const chordTypes = {
            'maj7': 'Mayor (Maj7)', 'm7': 'Menor (m7)', 'dom7': 'Dominante (V7)',
            'm7b5': 'Menor 7b5 (ø)', 'alt': 'Dominante Alterado (V7alt)'
        };
        const pentatonicToChordRelations = {
            'maj7': [
                { name: 'Menor del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'minor', logic: 'La mejor opción, excelentes tensiones.' },
                { name: 'Menor del 7mo grado', pentatonicRoot: (r) => (r + 11) % 12, type: 'minor', logic: 'Introduce el sonido Lidio (#11).' },
                { name: 'Menor del 6to grado', pentatonicRoot: (r) => (r + 9) % 12, type: 'minor', logic: 'Aporta un sonido bluesy.'},
                { name: 'Major b6 del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'majb6', logic: 'Crea un sonido Maj7#5.'},
                { name: 'm7b5 del #4', pentatonicRoot: (r) => (r + 6) % 12, type: 'm7b5', logic: 'Sonido Lidio con #11 y 13.'}
            ],
            'm7': [
                { name: 'Menor de la raíz', pentatonicRoot: (r) => r, type: 'minor', logic: 'La opción más directa y segura.' },
                { name: 'Menor del 5to grado', pentatonicRoot: (r) => (r + 7) % 12, type: 'minor', logic: 'Sonido Dórico, añade la 9na.' },
                { name: 'Menor del 2do grado', pentatonicRoot: (r) => (r + 2) % 12, type: 'minor', logic: 'Añade la 9na y la 13ra.'}
            ],
            'dom7': [
                { name: 'Menor del 5to grado', pentatonicRoot: (r) => (r + 7) % 12, type: 'minor', logic: 'Opción Mixolidia estándar.' },
                { name: 'Dominante de la raíz', pentatonicRoot: (r) => r, type: 'dom7', logic: 'La pentatónica de dominante básica.' },
                { name: 'Menor del 6to grado', pentatonicRoot: (r) => (r + 9) % 12, type: 'minor', logic: 'Sonido muy bluesy.'},
                { name: 'm7b5 del 3er grado', pentatonicRoot: (r) => (r + 4) % 12, type: 'm7b5', logic: 'Introduce la b13 para un sonido alterado suave.'},
                { name: 'Majb6 del 2do grado', pentatonicRoot: (r) => (r + 2) % 12, type: 'majb6', logic: 'Sonido Lidio Dominante (#11).'}
            ],
            'm7b5': [
                { name: 'Menor del b3', pentatonicRoot: (r) => (r + 3) % 12, type: 'minor', logic: 'Una de las opciones preferidas en jazz.' },
                { name: 'm7b5 de la raíz', pentatonicRoot: (r) => r, type: 'm7b5', logic: 'La escala más directa para el acorde.'},
                { name: 'Dominante del b6', pentatonicRoot: (r) => (r + 8) % 12, type: 'dom7', logic: 'Genera 9 y 13 sobre el acorde.'},
                { name: 'Majb6 del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'majb6', logic: 'Añade tensiones de 9na y 11na.'}
            ],
            'alt': [
                { name: 'Menor del #9', pentatonicRoot: (r) => (r + 3) % 12, type: 'minor', logic: 'Cubre todas las alteraciones importantes.' },
                { name: 'Dominante del b5', pentatonicRoot: (r) => (r + 6) % 12, type: 'dom7', logic: 'Opción de tritono, muy potente.' },
                { name: 'Dominante del #5', pentatonicRoot: (r) => (r + 8) % 12, type: 'dom7', logic: 'Otra opción con 3 alteraciones.'},
                { name: 'Major b6 del b6', pentatonicRoot: (r) => (r + 8) % 12, type: 'majb6', logic: 'Sonido avanzado con #9 y b13.'},
                { name: 'm7b5 del b7', pentatonicRoot: (r) => (r + 10) % 12, type: 'm7b5', logic: 'Cubre b9, #9, y #5.'}
            ]
        };
        const guitarTuning = [4, 9, 2, 7, 11, 4]; // E A D G B e

        const getArpeggiosForMinorPentatonic = (pentatonicNotes, preferredNotes) => {
            const [n1, n_b3, n4, n5, n_b7] = pentatonicNotes;
            const format = (name, notes) => `${name.padEnd(12, ' ')} ${notes.join(', ')}`;
            
            const triadas = [
                format(`${n1}m:`, [n1, n_b3, n5]),
                format(`${n_b3}sus2:`, [n_b3, n4, n_b7]),
                format(`${n4}sus2:`, [n4, n5, n1]),
                format(`${n_b3}/${n5}:`, [n5, n_b7, n_b3]), 
                format(`${n_b7}sus2:`, [n_b7, n1, n4])
            ];

            const tetradas = [
                format(`${n1}m7:`, [n1, n_b3, n5, n_b7]),
                format(`${n_b3}6sus2:`, [n_b3, n4, n_b7, n1]),
                format(`${n4}7sus2:`, [n4, n5, n1, n_b3]),
                format(`${n_b3}add9/${n5}:`, [n5, n_b7, n_b3, n4]),
                format(`${n_b7}6sus2:`, [n_b7, n1, n4, n5])
            ];

            return { triadas, tetradas };
        };
        
        const getArpeggiosForDom7Pentatonic = (pentatonicNotes) => {
            const [n1, n2, n3, n5, n_b7] = pentatonicNotes;
            const format = (name, notes) => `${name.padEnd(12, ' ')} ${notes.join(', ')}`;
            const triadas = [
                format(`${n1} (Mayor):`, [n1, n3, n5]),
                format(`${n5}m/${n2}:`, [n2, n5, n_b7]),
                format(`${n1}7(omit5)/${n3}:`, [n3, n_b7, n1]),
                format(`${n5}sus4:`, [n5, n1, n2]),
                format(`${n5}m/${n_b7}:`, [n_b7, n2, n5])
            ];
            const tetradas = [
                format(`${n1}7:`, [n1, n3, n5, n_b7]),
                format(`${n5}m7/${n2}:`, [n2, n5, n_b7, n1]),
                format(`${n1}7(add9)/${n3}:`, [n3, n_b7, n1, n2]),
                format(`${n5}m6:`, [n5, n_b7, n2, n3]),
                format(`${n1}sus2/${n_b7}:`, [n_b7, n1, n2, n5])
            ];
            return { triadas, tetradas };
        };

        const getArpeggiosForM7b5Pentatonic = (pentatonicNotes) => {
            const [n1, n_b3, n4, n_b5, n_b7] = pentatonicNotes;
            const format = (name, notes) => `${name.padEnd(12, ' ')} ${notes.join(', ')}`;
            const triadas = [
                format(`${n1}sus4:`, [n1, n4, n_b7]),
                format(`${n1}dim/${n_b3}:`, [n_b3, n_b5, n1]),
                format(`Cuartal:`, [n4, n_b7, n_b3]),
                format(`Shell Voicing:`, [n_b5, n_b7, n4]),
                format(`${n4}sus4/${n_b7}:`, [n_b7, n1, n4])
            ];
            const tetradas = [
                format(`${n1}m7b5:`, [n1, n_b3, n_b5, n_b7]),
                format(`${n1}dim(add11)/${n_b3}:`, [n_b3, n_b5, n1, n4]),
                format(`${n1}m7sus4:`, [n4, n_b7, n1, n_b3]),
                format(`${n_b7}7sus4/${n_b5}:`, [n_b5, n_b7, n1, n4]),
                format(`${n4}m7/${n_b7}:`, [n_b7, n1, n_b3, n4])
            ];
            return { triadas, tetradas };
        };

        const getArpeggiosForMajb6Pentatonic = (pentatonicNotes) => {
            const [n1, n2, n3, n5, n_b6] = pentatonicNotes;
            const format = (name, notes) => `${name.padEnd(12, ' ')} ${notes.join(', ')}`;
            const triadas = [
                format(`${n1}sus2:`, [n1, n2, n5]),
                format(`${n1}/${n2}:`, [n2, n5, n1]),
                format(`${n_b6}aug:`, [n3, n_b6, n1]),
                format(`${n1}/${n5}:`, [n5, n1, n3]),
                format(`${n_b6}aug:`, [n_b6, n1, n3])
            ];
            const tetradas = [
                format(`${n_b6}maj7#5:`, [n1, n3, n5, n_b6]),
                format(`${n1}maj7/${n2}:`, [n2, n3, n5, n1]),
                format(`${n_b6}7aug:`, [n3, n_b6, n1, n2]),
                format(`${n2}m6/${n5}:`, [n5, n_b6, n1, n2]),
                format(`${n_b6}maj7#11:`, [n_b6, n1, n2, n3])
            ];
            return { triadas, tetradas };
        };

        // --- Tone.js and other variables ---
        let isToneStarted = false;
        let currentProgressionType = 'major';
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        const melodySynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const stopPlayback = () => { Tone.Transport.stop(); Tone.Transport.cancel(); };
        
        // --- DOM Elements ---
        const rootNoteSelect = document.getElementById('root-note');
        const chordTypeSelect = document.getElementById('chord-type');
        const tableBody = document.getElementById('scale-table-body');
        const progressionContainer = document.getElementById('progression-container');
        const progressionKeySelect = document.getElementById('progression-key');
        const simpleModeContent = document.getElementById('simple-mode-content');

        const createFretboard = (containerId, numFrets = 17) => {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            const area = document.createElement('div');
            area.className = 'fretboard-area';

            const openStringsContainer = document.createElement('div');
            openStringsContainer.className = 'open-strings';
            ['E', 'B', 'G', 'D', 'A', 'E'].forEach(noteName => {
                const nameDiv = document.createElement('div');
                nameDiv.className = 'open-string-name';
                nameDiv.textContent = noteName;
                openStringsContainer.appendChild(nameDiv);
            });
            area.appendChild(openStringsContainer);

            const wrapper = document.createElement('div');
            wrapper.className = 'fretboard-wrapper';

            const fretboard = document.createElement('div');
            fretboard.className = 'fretboard';
            
            [...guitarTuning].reverse().forEach((openNoteIndex, stringIndex) => {
                const stringDiv = document.createElement('div');
                stringDiv.className = 'string';
                
                const nut = document.createElement('div');
                nut.className = 'fret nut';
                nut.dataset.string = 5 - stringIndex;
                nut.dataset.fret = 0;
                stringDiv.appendChild(nut);
                
                for (let i = 0; i < numFrets; i++) {
                    const fret = document.createElement('div');
                    fret.className = 'fret';
                    fret.dataset.string = 5 - stringIndex;
                    fret.dataset.fret = i + 1;
                    stringDiv.appendChild(fret);
                }
                fretboard.appendChild(stringDiv);
            });
            wrapper.appendChild(fretboard);
            
            const inlayContainer = document.createElement('div');
            inlayContainer.className = 'inlay-container';
            const markers = { 3: 'single', 5: 'single', 7: 'single', 9: 'single', 12: 'double', 15: 'single', 17: 'single' };
            
            for (let i = 1; i <= numFrets; i++) {
                const inlayFret = document.createElement('div');
                inlayFret.className = 'inlay-fret';
                if (markers[i]) {
                    const dot = document.createElement('div');
                    dot.className = `inlay-dot ${markers[i] === 'double' ? 'double' : ''}`;
                    inlayFret.appendChild(dot);
                }
                inlayContainer.appendChild(inlayFret);
            }
            wrapper.appendChild(inlayContainer);

            area.appendChild(wrapper);
            container.appendChild(area);
        };

        const updateFretboard = (containerId, rootNote, scaleNotes, preferredNotes) => {
            document.querySelectorAll(`#${containerId} .note-dot`).forEach(dot => dot.remove());
            document.querySelectorAll(`#${containerId} .open-string-name`).forEach(label => {
                label.classList.remove('in-scale', 'root');
            });

            const scaleNoteIndices = scaleNotes.map(noteNameToIndex);
            const rootNoteIndex = noteNameToIndex(rootNote);
            
            const reversedTuning = [...guitarTuning].reverse();

            for (let string = 0; string < 6; string++) { // 0 = high e, 5 = low E
                const openNoteIndex = reversedTuning[string];
                const openStringNoteIndex = openNoteIndex % 12;

                if (scaleNoteIndices.includes(openStringNoteIndex)) {
                    const openStringLabel = document.querySelector(`#${containerId} .open-string-name:nth-child(${string + 1})`);
                    if (openStringLabel) {
                        openStringLabel.classList.add('in-scale');
                        if (openStringNoteIndex === rootNoteIndex) {
                            openStringLabel.classList.add('root');
                        }
                    }
                }
                
                for (let fret = 1; fret < 18; fret++) {
                    const currentNoteIndex = (openNoteIndex + fret) % 12;
                    if (scaleNoteIndices.includes(currentNoteIndex)) {
                        const fretDiv = document.querySelector(`#${containerId} .fret[data-string='${5-string}'][data-fret='${fret}']`);
                        if (fretDiv) {
                            const noteDot = document.createElement('div');
                            noteDot.className = 'note-dot';
                            const noteName = preferredNotes[currentNoteIndex];
                            noteDot.textContent = noteName;
                            if (currentNoteIndex === rootNoteIndex) {
                                noteDot.classList.add('root');
                            }
                            fretDiv.appendChild(noteDot);
                        }
                    }
                }
            }
        };

        const renderSimpleMode = () => {
            const rootNote = rootNoteSelect.value;
            const chordType = chordTypeSelect.value;
            if (!rootNote || !chordType) {
                simpleModeContent.classList.add('hidden');
                return;
            }
            simpleModeContent.classList.remove('hidden');
            tableBody.innerHTML = '';
            const relations = pentatonicToChordRelations[chordType] || [];
            const preferredNotes = getPreferredNotes(rootNote, chordType);
            relations.forEach(rel => {
                const pentatonicRootIndex = rel.pentatonicRoot(noteNameToIndex(rootNote));
                const pentatonicPreferredNotes = preferredNotes;
                const pentatonicRoot = pentatonicPreferredNotes[pentatonicRootIndex];
                
                let pentatonicNotes;
                if (rel.type === 'minor' && MINOR_PENTATONIC_SCALES[pentatonicRoot]) {
                    pentatonicNotes = MINOR_PENTATONIC_SCALES[pentatonicRoot];
                } else {
                    pentatonicNotes = pentatonicFormulas[rel.type].map(interval => getNoteFromInterval(pentatonicRoot, interval, pentatonicPreferredNotes));
                }

                const degrees = pentatonicNotes.map(note => getIntervalName(rootNote, note, chordType));
                let triadasHtml, tetradasHtml, arpeggios;
                switch (rel.type) {
                    case 'minor': arpeggios = getArpeggiosForMinorPentatonic(pentatonicNotes, pentatonicPreferredNotes); break;
                    case 'dom7': arpeggios = getArpeggiosForDom7Pentatonic(pentatonicNotes); break;
                    case 'm7b5': arpeggios = getArpeggiosForM7b5Pentatonic(pentatonicNotes); break;
                    case 'majb6': arpeggios = getArpeggiosForMajb6Pentatonic(pentatonicNotes); break;
                    default: arpeggios = null;
                }
                if (arpeggios) {
                    triadasHtml = `<td><div class="example-box">${arpeggios.triadas.join('\n')}</div></td>`;
                    tetradasHtml = `<td><div class="example-box">${arpeggios.tetradas.join('\n')}</div></td>`;
                } else {
                    triadasHtml = '<td><div class="example-box text-gray-500">N/A</div></td>';
                    tetradasHtml = '<td><div class="example-box text-gray-500">N/A</div></td>';
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="font-bold text-lg">${pentatonicRoot} <span class="text-sm text-gray-400">${rel.type}</span></div>
                        <div class="text-xs mt-1">${pentatonicNotes.join(', ')}</div>
                    </td>
                    ${triadasHtml}
                    ${tetradasHtml}
                    <td><div class="example-box">${degrees.join(', ')}</div></td>
                    <td>${rel.logic}</td>
                `;
                row.addEventListener('click', () => {
                    document.querySelectorAll('#scale-table-body tr').forEach(r => r.classList.remove('selected-row'));
                    row.classList.add('selected-row');
                    updateFretboard('fretboard-container-simple', pentatonicRoot, pentatonicNotes, pentatonicPreferredNotes);
                });
                tableBody.appendChild(row);
            });
            if (tableBody.firstChild) tableBody.firstChild.click();
        };
        
        const renderProgression = () => {
            const key = progressionKeySelect.value;
            let progressionChords, progressionHtml = '';
            const preferredKeyNotes = getPreferredNotes(key, 'maj7');
            if (currentProgressionType === 'major') {
                 progressionChords = [
                    { name: `${getNoteFromInterval(key, 2, preferredKeyNotes)}m7`, type: 'm7' }, 
                    { name: `${getNoteFromInterval(key, 7, preferredKeyNotes)}7alt`, type: 'alt' }, 
                    { name: `${key}maj7`, type: 'maj7' }
                 ];
            } else {
                 progressionChords = [
                    { name: `${getNoteFromInterval(key, 2, preferredKeyNotes)}m7(b5)`, type: 'm7b5' }, 
                    { name: `${getNoteFromInterval(key, 7, preferredKeyNotes)}7alt`, type: 'alt' }, 
                    { name: `${key}m7`, type: 'm7' }
                 ];
            }
            progressionHtml = '<div class="progression-table">';
            progressionChords.forEach(chord => {
                const chordRoot = chord.name.replace(/m7\(b5\)|m7|7alt|maj7/g, '');
                const relations = pentatonicToChordRelations[chord.type];
                const preferredChordNotes = getPreferredNotes(chordRoot, chord.type);
                let suggestionsHtml = relations.map(rel => {
                    const pRootIndex = rel.pentatonicRoot(noteNameToIndex(chordRoot));
                    const pRoot = preferredChordNotes[pRootIndex];
                    
                    let pNotesArray;
                    if (rel.type === 'minor' && MINOR_PENTATONIC_SCALES[pRoot]) {
                        pNotesArray = MINOR_PENTATONIC_SCALES[pRoot];
                    } else {
                        pNotesArray = pentatonicFormulas[rel.type].map(i => getNoteFromInterval(pRoot, i, preferredChordNotes));
                    }
                    const pNotes = pNotesArray.join(',');

                    const preferredType = preferredChordNotes === SHARP_NOTES ? 'sharp' : 'flat';
                    return `<li class="text-sm cursor-pointer hover:text-white p-1 rounded" data-root="${pRoot}" data-notes="${pNotes}" data-preferred="${preferredType}">
                                <span class="text-blue-400">${pRoot}</span> pent. ${rel.type}
                            </li>`;
                }).join('');
                progressionHtml += `
                    <div class="chord-column">
                        <div class="chord-box">${chord.name}</div>
                        <div class="progression-card mt-2">
                            <p class="text-sm font-semibold mb-1">Pentatónicas sugeridas:</p>
                            <ul class="scale-suggestions space-y-1">${suggestionsHtml}</ul>
                        </div>
                    </div>
                `;
            });
            progressionHtml += '</div>';
            progressionContainer.innerHTML = progressionHtml;
        };

        const fillSelects = () => {
            Object.keys(KEY_SIGNATURES).forEach(note => {
                const option = `<option value="${note}">${note}</option>`;
                rootNoteSelect.innerHTML += option;
                progressionKeySelect.innerHTML += option;
            });
            Object.keys(chordTypes).forEach(type => {
                chordTypeSelect.innerHTML += `<option value="${type}">${chordTypes[type]}</option>`;
            });
            rootNoteSelect.value = 'C';
            chordTypeSelect.value = 'maj7';
            progressionKeySelect.value = 'C';
        };

        const setupEventListeners = () => {
            const allButtons = document.querySelectorAll('button, select');
            allButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (!isToneStarted) {
                        await Tone.start();
                        isToneStarted = true;
                    }
                });
            });

            rootNoteSelect.addEventListener('change', renderSimpleMode);
            chordTypeSelect.addEventListener('change', renderSimpleMode);
            progressionKeySelect.addEventListener('change', renderProgression);
            document.getElementById('stop-btn').addEventListener('click', stopPlayback);

            progressionContainer.addEventListener('click', (e) => {
                const targetLi = e.target.closest('li');
                if (targetLi) {
                    progressionContainer.querySelectorAll('li').forEach(li => li.classList.remove('selected-scale'));
                    targetLi.classList.add('selected-scale');
                    const root = targetLi.dataset.root;
                    const notes = targetLi.dataset.notes.split(',');
                    const preferredType = targetLi.dataset.preferred;
                    const preferredNotes = preferredType === 'sharp' ? SHARP_NOTES : FLAT_NOTES;
                    updateFretboard('fretboard-container-progression', root, notes, preferredNotes);
                }
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`tab-${button.dataset.tab}`).classList.remove('hidden');
                });
            });

            document.querySelectorAll('.prog-type-selector button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.prog-type-selector button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentProgressionType = button.dataset.progType;
                    renderProgression();
                });
            });
        };
        
        // --- START APP ---
        fillSelects();
        createFretboard('fretboard-container-simple');
        createFretboard('fretboard-container-progression');
        setupEventListeners();
        renderSimpleMode();
        renderProgression(); 
    });
    </script>
</body>
</html>

